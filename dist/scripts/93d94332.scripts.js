"use strict";angular.module("BSMashup.Webapp",["ui.router","restangular","BSMashup.BetaSeries"]).config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|magnet):/)}]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/series/episodes"),a.state("landing",{url:"/landing",templateUrl:"views/landing.html",controller:"LandingCtrl"}).state("series",{"abstract":!0,url:"/series",templateUrl:"views/series.html",controller:["$scope",function(a){a.$on("breadcrumb",function(b,c){a.breadcrumb=c})}]}).state("series.episodes",{url:"/episodes",templateUrl:"views/series.episodes.html",controller:"EpisodesCtrl",resolve:{episodesList:["BetaSeries",function(a){return a.rest.all("episodes").getList()}]}}).state("series.details",{url:"/:showId",templateUrl:"views/series.details.html",controller:"ShowDetailsCtrl",resolve:{showDetails:["BetaSeries","$stateParams",function(a,b){return a.rest.all("shows").getDetails({id:b.showId})}],episodesList:["BetaSeries","$stateParams",function(a,b){return a.rest.all("episodes").getList(b)}]}}).state("series.episode",{url:"/:showId/episode/:id",templateUrl:"views/series.episodes.details.html",controller:"EpisodeDetailsCtrl",resolve:{episodeDetails:["BetaSeries","$stateParams",function(a,b){return a.rest.all("episodes").getDetails({id:b.id,subtitles:!0})}],torrentsList:["Fenopy","BetaSeries","$stateParams",function(a,b,c){return b.rest.all("episodes").getDetails({id:c.id,subtitles:!0}).then(function(a){return a.episode}).then(function(b){return a.search(b.show_title+" 720p "+b.code,10)})}]}})}]),angular.module("BSMashup.Webapp").controller("StateChangeCtrl",["$scope","$state","$location","BetaSeries",function(a,b,c,d){a.logout=function(){d.logout(),b.go("landing")},console.log("mainCtrl loaded"),a.$on("$stateChangeStart",function(){console.log("$stateChangeStart"),NProgress.start()}),a.$on("$stateChangeSuccess",function(){console.log("$stateChangeSuccess"),NProgress.done(!0)}),a.$on("$stateChangeError",function(c,e,f,g,h,i){console.log("$stateChangeError",c,e,f,g,h,i),NProgress.done(!0),a.toState=e,a.toParam=f,400===i.status&&i.data&&i.data.errors&&2001===i.data.errors[0].code&&(d.logout(),b.go("landing"))})}]),angular.module("BSMashup.Webapp").controller("EpisodesCtrl",["$scope","episodesList",function(a,b){a.shows=b.shows,a.$emit("breadcrumb",[["Séries","#/series/episodes"],["Épisodes","#/series/episodes"]])}]),angular.module("BSMashup.BetaSeries",["restangular","LocalStorageModule"]).config(["localStorageServiceProvider",function(a){a.setPrefix("BSMashup.BetaSeries")}]).service("BetaSeries",["Restangular","localStorageService","BETA_SERIES_BASE_URL","BETA_SERIES_CALLBACK_URL","BETA_SERIES_KEY","BETA_SERIES_SECRET_KEY","BETA_SERIES_VERSION","$rootScope","$window","$location","$q",function(a,b,c,d,e,f,g,h,i,j,k){function l(){n.setDefaultHeaders({"X-BetaSeries-Version":g,"X-BetaSeries-Key":e,"X-BetaSeries-Token":m.token?m.token():void 0})}var m=this;m.token=function(a){return a?(m.loggedIn=!!a,void b.add("token",a)):b.get("token")},m.login=function(){console.log("loggin in");var a=k.defer();if(m.token())return a.resolve(),a.promise;var b={name:"BetaSeries login",openParams:{width:650,height:300,resizable:!0,scrollbars:!0,status:!0}},c={client_id:e,redirect_uri:d};console.log(c);var g=function(a){var b=[];return angular.forEach(a,function(a,c){(a||0===a)&&(a=a===!0?"yes":a,b.push(c+"="+a))}),b.join(",")},h=k.defer();return i.open("https://www.betaseries.com/authorize?client_id="+e+"&redirect_uri="+d,b.name,g(b.openParams)),window.addEventListener("message",function(a){a.origin===location.origin&&a.data.code&&h.resolve(a.data.code)}),h.promise.then(function(b){console.log("post call"),n.all("members").customPOST({},"access_token",{client_id:e,client_secret:f,redirect_uri:c.redirect_uri,code:b}).then(function(b){m.token(b.token),l(),a.resolve()})}),a.promise},m.logout=function(){b.clearAll(),l(),m.loggedIn=!1};var n=a.withConfig(function(a){a.setBaseUrl(c)});m.rest=n,n.addElementTransformer("episodes",!0,function(a){return a.addRestangularMethod("getList","get","list"),a.addRestangularMethod("getDetails","get","display"),a.addRestangularMethod("postDownloaded","post","downloaded"),a.addRestangularMethod("removeDownloaded","remove","downloaded"),a.addRestangularMethod("postWatched","post","watched"),a.addRestangularMethod("removeWatched","remove","watched"),a}),n.addElementTransformer("subtitles",!0,function(a){return a.addRestangularMethod("getList","get","episode"),a}),n.addElementTransformer("shows",!0,function(a){return a.addRestangularMethod("getDetails","get","display"),a}),l(),m.loggedIn=!!m.token()}]),angular.module("BSMashup.Webapp").controller("AuthCtrl",["$location","BetaSeries",function(a,b){return b.isLogedin()?void a.path("/"):void b.auth().then(function(){return b.isLogedin()?void a.path("/"):void 0})}]),angular.module("BSMashup.Webapp").factory("FenopyRestangular",["Restangular",function(a){return a.withConfig(function(a){a.setBaseUrl("http://www.corsproxy.com/fenopy.se/module/search"),a.setDefaultRequestParams("get",{limit:"15",format:"json"})}).all("api.php")}]).service("Fenopy",["FenopyRestangular",function(a){return{search:function(b,c){return a.getList({keyword:b,limit:c})}}}]),angular.module("BSMashup.Webapp").directive("episode",function(){return{templateUrl:"views/directives/episode.html",restrict:"E",replace:!0,scope:{show:"=",ep:"=data"},controller:["$scope","$window","$q","Fenopy","BetaSeries",function(a,b,c,d,e){var f=e.rest.all("episodes"),g=e.rest.all("subtitles");a.openMagnet=function(a,e){NProgress.start();var g=d.search(e.title+" 720p "+a.code,10).then(function(a){b.location=a[1].magnet}),h=f.postDownloaded({},{id:a.id}).then(function(){a.user.downloaded=!0}).finally(function(){console.log("yo")});c.all(g,h).then(NProgress.done)},a.openSubtitle=function(a){NProgress.start(),g.getList({id:a.id,language:"vf"}).then(function(a){a.subtitles.sort(function(a,b){return a.quality>b.quality?-1:a.quality<b.quality?1:0}),window.location=a.subtitles[0].url}).finally(NProgress.done)},a.setDownloaded=function(a){NProgress.start();var b;return b=a.user.downloaded?f.removeDownloaded({},{id:a.id}):f.postDownloaded({},{id:a.id}),b.then(function(){a.user.downloaded=!a.user.downloaded}).finally(function(){NProgress.done()})},a.setWatched=function(a){NProgress.start();var b;return b=a.user.seen?f.removeWatched({},{id:a.id}):f.postWatched({},{id:a.id}),b.then(function(){a.user.seen=!a.user.seen}).finally(function(){NProgress.done()})}}]}}),angular.module("BSMashup.Webapp").controller("ShowDetailsCtrl",["$scope","showDetails","episodesList",function(a,b,c){a.show=b.show,a.unseen=c.shows[0].unseen,a.$emit("breadcrumb",[["Séries","#/series/episodes"],[b.show.title,"#/series/"+b.show.id]])}]),angular.module("BSMashup.Webapp").controller("EpisodeDetailsCtrl",["$scope","episodeDetails","torrentsList","BetaSeries",function(a,b,c,d){a.episode=b.episode,a.torrents=c,a.$emit("breadcrumb",[["Séries","#/series/episodes"],[b.episode.show_title,"#/series/"+b.episode.show_id],[b.episode.code+" - "+b.episode.title,"#/series/"+b.episode.show_id+"/episode/"+b.episode.id]]);{var e=d.rest.all("episodes");d.rest.all("subtitles")}a.setDownloaded=function(a){NProgress.start();var b;return b=a.user.downloaded?e.removeDownloaded({},{id:a.id}):e.postDownloaded({},{id:a.id}),b.then(function(){a.user.downloaded=!a.user.downloaded}).finally(function(){NProgress.done()})},a.setWatched=function(a){NProgress.start();var b;return b=a.user.seen?e.removeWatched({},{id:a.id}):e.postWatched({},{id:a.id}),b.then(function(){a.user.seen=!a.user.seen}).finally(function(){NProgress.done()})}}]),angular.module("BSMashup.Webapp").directive("semSidebar",function(){return{restrict:"A",link:function(a,b){b.sidebar(window.innerWidth<768?{overlay:!0}:"show")}}}),angular.module("BSMashup.Webapp").controller("LandingCtrl",["$scope","$state","$window","BetaSeries",function(a,b,c,d){return d.loggedIn?b.go("series.episodes"):void(a.login=function(){d.login().then(function(){b.go("series.episodes")})})}]),angular.module("BSMashup.BetaSeries").config(["$provide",function(a){a.value("BETA_SERIES_CALLBACK_URL",window.location.origin+window.location.pathname+"oauth.html"),a.value("BETA_SERIES_BASE_URL","https://plop.io/bsmashup/betaseries"),a.value("BETA_SERIES_KEY","4614F428BAD8"),a.value("BETA_SERIES_SECRET_KEY","6805b9afc390b0fc1cc20c8c7eabff0e"),a.value("BETA_SERIES_VERSION","2.2")}]);